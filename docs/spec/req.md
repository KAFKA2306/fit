# 要件定義書 (Requirement Specification) - Outfit Retargeting System

## 1. 概要
本プロジェクトは、3D衣装（FBX形式）を複数のベースアバターの体型およびポーズに自動的に適合（リターゲット）させるシステムです。
本システムにおいては、従来のモノリシックな構造を廃止し、明確なフェーズに分割されたパイプライン構造を採用することで、保守性と機能の拡張性を向上させています。

## 2. 機能要件

### 2.1 パイプライン制御
- `OutfitRetargeter` クラスによる段階的な処理の実行。
- シーン初期化、アバター処理、ポーズ合わせ、衣装セットアップ、ウェイト処理、メッシュ変形、ファイル出力の各ステップの直列実行。
- `RetargetContext` オブジェクトによる処理状態およびキャッシュの一元管理。

### 2.2 前処理と安定化 (Stabilization)
- 初期ポーズ合わせ: JSON形式のポーズデータをアーマチュアに適用し、リターゲットの数学的基盤となる「標準状態」を構成。
- 衣装メッシュのクリーンアップ（孤立頂点、非有限値の削除）。
- 衣装とアバターのヒップボーン位置の自動調整。
- 衣装メッシュのエッジ分割（Subdivision）による変形品質の向上。
- 衣装側のBlendShapeキー名の正規化。

### 2.3 ウェイト管理と転送
- ベースアバターから衣装メッシュへの高精度なウェイト転送。
- 無効なウェイト（NaNや無限値）の自動修復。
- 特定のボーン（UpperChest、Breasts、つま先等）のウェイト統合（Consolidation）。
- ウェイト未割り当て頂点への周辺ウェイト波及（Propagation）。
- 重複頂点（Overlapped）の属性識別。

### 2.4 幾何学的分類と変形適用 (Selection of DoF)
- Component-based Separation: メッシュを連結成分（Component）ごとに自動分離。
- OBB分類判定:
    - 各成分とベースアバターの干渉状況をOBB（有向境界ボックス）を用いて判定。
    - 交差しないパーツ: 「自由度が高い」と判断し、SVDを用いた剛体変換または相似変換を適用。
    - 交差するパーツ: 「人体追従が必要」と判断し、RBF（径向基関数）を用いた柔軟な変形を適用。
- 変形フィールドの適用: 外部から供給されるフィールドデータ（`.npz`）に基づき、KDTreeを用いた空間補間を実行。

### 2.5 堅牢性と相互運用性 (Robustness & Interoperability)
- 進捗報告: 各処理ステップ（0.00〜1.00）を標準出力へリアルタイム送信（Unity連携用）。
- 構造化ロギング: `print`を使用せず、Python標準`logging`モジュールによる制御されたログ出力。
- クラッシュダンプ: 未処理例外発生時に、スタックトレースの出力と共にデバッグ用`.blend`ファイルを自動保存。

## 3. 技術要件

### 3.1 ソフトウェアスタック
- 実行環境: Python 3.11, Blender 3.6+ (bpy 実行環境)
- 主要ライブラリ:
    - `numpy`: ベクトル演算、行列計算。
    - `scipy`: `cKDTree` による高速近傍探索、SVDによる剛体変換計算。
    - `mathutils`: Blender独自の幾何計算モジュール。

### 3.2 設計原則
- ミニマリズム: 型ヒントの徹底、不必要なエラーハンドリングの排除、最小構成のコンポーネント。
- コンフィギュラビリティ: ハードコーディングを避け、`config.yaml`、各種JSON、およびコマンドライン引数からの入力を優先。
- リサーチ・ドリブン: OBB干渉判定やSVD変換など、数学的正当性に裏打ちされたアルゴリズムの採用。

## 4. 入出力インターフェース

### 4.1 入力データ
- ベースとなるBlenderシーンファイル (`.blend`)
- ベースアバターおよび衣装のFBXファイル。
- 各種メタデータ（JSON形式）:
    - ボーン階層、ヒューマノイドボーンマッピング、BlendShapeグループ定義。
- 変形フィールドデータ (`.npz`):
    - 頂点座標とデルタ値の配列。

### 4.2 出力データ
- リターゲットが適用された最終的なFBXファイル。

## 5. 主要モジュール構成
- `main.py`: エントリポイント。引数パースとパイプライン起動。
- `retargeter.py`: パイプラインの各ステップのオーケストレーション。
- `geometry.py`: 幾何計算、変形アルゴリズム、OBB計算。
- `deformation.py`: リターゲット中核ロジック（剛体/非剛体変形の適用）。
- `weights.py`: ウェイト転送、修復、統合、波及。
- `mesh.py`: メッシュのクリーンアップ、分割、コンポーネント分離。
- `armature.py`: ボーン操作、ポーズ行列計算、Hips調整。
- `blendshapes.py`: BlendShapeの管理、同期、遷移。

---

## ナビゲーション
- [ドキュメント目次](../README.md)
- [システム概要 (Overview)](../architecture/overview.md)
