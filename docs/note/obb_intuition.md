# 自動仕分けの魔法：硬いモノと柔らかいモノ

衣装には、大きく分けて2種類のパーツがあります。
ひとつは「布」。これは体の動きに合わせて伸び縮みしてほしい。
もうひとつは「アクセサリー」。ボタンやバックル、靴などは、伸びてしまうとカッコ悪い。

このツールは、それらを全自動で見分けています。

## どうやって見分けているの？

「箱 (OBB)」を使っています。
ユーザーの方から「もっと詳しく知りたい」という声があったので、少しだけ裏側のロジックを解説します。

### ステップ1：パーツごとの箱を作る

システムは、まず衣装をバラバラのパーツ（ボタン、袖、襟など）に分解します。
そして、そのパーツがぴったり収まる「最小の箱」を計算します。
これを専門用語でOBB（有向境界ボックス）と呼びます。

#### 箱の向きはどう決まる？

ただの真四角な箱ではありません。パーツの形に合わせて回転した箱を作ります。
例えば「斜めに置かれたフランスパン」を想像してください。
これを「東西南北に平行な箱」に入れようとすると、スカスカの巨大な箱が必要になってしまいます。
しかし「パンの傾きに合わせた箱」なら、最小限のサイズでぴったり収まります。


このツールは、統計分析（主成分分析）を使って「そのパーツが一番長く伸びている方向」を自動で見つけ出し、それに合わせて箱を回転させています。

さらに、ごく小さなボタンのようなパーツや、ペラペラの平面など、箱を作れないような形状の場合は、無理に箱を作らずに安全にスキップする「自動回避機能」も備わっています。

### ステップ2：箱の中に「体」があるか？

ここが判定のキモです。システムは次にこう問いかけます。
「この箱の中に、素体（アバター）の肌が入り込んでいるか？」

### 判定A：肌が入っている場合（袖やスカート）
箱の中に素体のメッシュ（頂点）がひとつでも入っていれば、「これは体に密着している布だ」と判断します。
この場合、前回の記事で紹介した「ゴムのような処理 (RBF)」を使って、柔らかく変形させます。

### 判定B：肌が入っていない場合（ボタンやバックル）
箱の中が完全に空っぽなら、「これは体から遊離している装飾品だ」と判断します。
この場合は、形を変えずに「場所だけ」を動かします。

## 設定値はありません

「しきい値は？」「何％重なったら？」といった細かい設定は一切ありません。
現在のコードでは、「1点でも接触したらアウト（＝布扱い）」という非常にシンプルなルールで動いています。
複雑なバラメータ調整に悩む必要がないのは、このためです。

## なぜこれが重要？

昔の自動ツールでは、キャラが太った時に「ベルトのバックルまで横に伸びて楕円になる」という悲劇がよく起きました。
しかしこのシステムなら、バックルは「硬いまま」、ベルトの革部分だけが「伸びる」という、現実と同じ挙動になります。

皆さんが何も設定しなくても、ツールが勝手に「箱の中に肌があるか？」をチェックして、適切な処理を選んでくれるわけです。
